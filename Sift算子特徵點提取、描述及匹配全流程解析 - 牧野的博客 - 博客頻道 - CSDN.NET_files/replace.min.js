$(function(){(function(){var oReplace={wsCache:new WebStorageCache(),replace:function(){var _this=this;$.ajax({type:'get',url:'http://internalapi.csdn.net/knowledge/public/public/api/words?x-acl-token=9DeJLGuYSy/6nSmDQen5amEWUh0K',async:false,dataType:'jsonp',jsonp:'callback',success:function(resobj){if(resobj.msg=="ok"){var resData=resobj.data;var storage=window.localStorage;var data=eval(resData);if(_this.wsCache.isSupported()){_this.wsCache.set('realData',resData,{exp:86400,force:true})}_this.handle($("#article_content"),data)}},error:function(){console.log("Send Ajax error ...")}})},handler:function(){var _this=this;_this.wsCache.deleteAllExpires();var data=window.localStorage.getItem('realData');if(!data){_this.replace()}else{if(JSON.parse(data).hasOwnProperty('v')){data=(JSON.parse(localStorage.getItem('realData'))).v}else{data=JSON.parse(localStorage.getItem('realData'))}data=eval(data);_this.handle($("#article_content"),data)}},handle:function(obj,data){var _this=this;var regarr=[],arrUrl=[],arrTip=[],arrLogo=[],arrSubCount=[],arrConCount=[],arrWord=[];for(var a=0;a<data.length;a++){data[a].flg=false}var temp=obj.html();start(obj,data);function start(obj,data){selectext(obj,data);var ret=temp.replace(/(<p>|<p\s+([^>]+>))(((?!<\/p)[\s\S])+)<\/p>/ig,function(pTagAll,tagOpen,tagAttr,subContent){var modifiedContent=subContent.replace(/((<[^>]+>)*)([^<]*)/mig,function(all,tag,lastTag,text){if(!tag){tag=''}if(!text){text=''}else{if(tag.indexOf('<a')!=-1||arrWord.length===0){text=text}else{var indexToDel=[];for(var i in arrWord){var reg=arrWord[i].reg;if(text.search(reg)!==-1&&i!="contain"){text=text.replace(reg,"{[("+i+")]}");indexToDel.push(i)}}for(var j=0;j<indexToDel.length;j++){var index=indexToDel[j];var sub=arrWord[index];text=text.replace("{[("+index+")]}","<a href=\""+sub.url+"\" class='replace_word' title=\""+sub.tip+"\" target='_blank' style='color:#df3434; font-weight:bold;'>"+sub.word+"</a>");delete arrWord[index]}}}return tag+text});return tagOpen+modifiedContent+'</p>'});obj.html(ret)}function selectext(subs,data){var oHtml=subs.text();var regflg=false;function escapeSpecial(string){var escapeMap={"$":"\\$","*":"\\*","(":"\\(",")":"\\)","+":"\\+",".":"\\.","?":"\\?","^":"\\^","|":"\\|"};return String(string).replace(/[$*()+.?^|]/g,function(s){return escapeMap[s]})}for(var i=0;i<data.length;i++){var str=data[i].word;var Str=escapeSpecial(str);var regStr=/([\u4e00-\u9fa5]+)\w*/ig.test(Str)?Str:'\\b'+Str+'\\b';var Reg=new RegExp(regStr,'i');if(oHtml.search(Reg)!==-1){if(regarr.length<=0){regarr.push((Reg+''))}else{for(var e=0;e<regarr.length;e++){if(Reg!=regarr[e]){regflg=true}else{regflg=false}}}if(regflg){regarr.push((Reg+''))}regarr=_this.unique(regarr);var strUrl=data[i].url,strTip=data[i].name,strLogo=data[i].logo,strSubCount=data[i].subCount,strConCount=data[i].conCount,strWord=data[i].word;arrUrl.push(strUrl);arrTip.push(strTip);arrLogo.push(strLogo);arrSubCount.push(strSubCount);arrConCount.push(strConCount);arrWord.push({word:strWord,url:strUrl,tip:strTip,reg:Reg})}}arrWord=_this.uniqueObj(arrWord)}function relate(){var relateHtml='';var oRelate=document.getElementById('relate');if(arrTip.length<=0){oRelate.style.display='none'}else{oRelate.style.display='block';arrTip=_this.unique(arrTip);arrUrl=_this.unique(arrUrl);arrTip=_this.unique(arrTip);arrLogo=_this.unique(arrLogo);arrSubCount=_this.unique(arrSubCount);arrConCount=_this.unique(arrConCount);for(var i=0;i<arrTip.length;i++){relateHtml+='<dl class="relate_list" ><dt><a target="_blank" href="'+arrUrl[i]+'"><img src="'+arrLogo[i]+'" alt="img"/></a></dt><dd><h4><a target="_blank" href="'+arrUrl[i]+'">'+arrTip[i]+'</a></h4><p><label><span>'+arrSubCount[i]+'</span><em>关注</em><i>|</i><span>'+arrConCount[i]+'</span><em>收录</em></label></p></dd></dl>'}$('.relate_c').html(relateHtml)}}relate()},unique:function(arr){var result=[],hash={};for(var i=0,elem;(elem=arr[i])!=null;i++){if(!hash[elem]){result.push(elem);hash[elem]=true}}return result},uniqueObj:function(obj){var arr=[];var words=[];if(obj.length){arr.push(obj[0]);words.push(obj[0].word);for(var i=1;i<obj.length;i++){words.push(obj[i].word);if(words.indexOf(obj[i].word)==i)arr.push(obj[i])}}return arr},classStyle:function(){var aReplace=$(".replace_word");aReplace.css({color:'#df3434',fontWeight:'bold!important'})}};try{oReplace.classStyle();oReplace.handler()}catch(error){console.log(error.message);return}}).call(this)});